{% extends "docs/base_docs.html" %}

{% block page_class %}docs{% endblock %}

{% block content %}
<h1 id="how-cluster-registration-works-in-maas">How cluster registration works in MAAS</h1>
<p>A region controller associates with one or more cluster controllers, each of which is responsible for contacting the region controller itself and announcing its presence. An admin must accept or reject each cluster that registers itself with the region controller, except in the special circumstance mentioned in first-cluster.</p>
<p>There is always at least one cluster controller in MAAS (known as a NodeGroup in the code) which is known as the 'master'. The Nodegroup entry always exists even if no cluster controllers have contacted the region controller yet, so that it can be used as a default when adding nodes in the API or UI before the cluster controller is defined. Once a real cluster controller connects it will become this master.</p>
<p>This logic was originally implemented as an easy way to upgrade older installations that were created before nodegroups were introduced.</p>
<h2 id="region-controller-location">Region Controller Location</h2>
<p>The cluster obviously needs to know where the region controller is, and this is configured in a file <code>/etc/maas/maas_cluster.conf</code> (or <code>etc/demo_maas_cluster.conf</code> for development environments).</p>
<h2 id="cluster-configuration-file">Cluster configuration file</h2>
<p>This config file generally contains two items like this:</p>
<pre><code>MAAS_URL=http://0.0.0.0:5240/
CLUSTER_UUID=&quot;adfd3977-f251-4f2c-8d61-745dbd690bf2&quot;</code></pre>
<p>The values here are the defaults in the development environment. MAAS_URL tells the cluster controller where to find the region controller.</p>
<p><code>CLUSTER_UUID</code> is what the region uses to tell clusters apart when they connect. Each cluster is free to generate its own UUID but the development environment fixes it in advance. The Ubuntu packaging generates a new UUID for a cluster controller each time it is installed.</p>
<blockquote>
<p><strong>warning</strong></p>
</blockquote>
<blockquote>
<p>The format of this config file is very sensitive due to the code that parses it. It will not accept quoting, or any kind of comments.</p>
</blockquote>
<h2 id="first-cluster-to-connect">First cluster to connect</h2>
<p>For the convenience of small setups (and the development environment), the first cluster controller to connect to the region controller becomes the 'master' nodegroup, and if the cluster connects <em>from the same host</em>, it is automatically accepted.</p>
<p>The logic currently looks like this:</p>
<ol>
<li>If there is one, the oldest nodegroup is the master.</li>
<li>If none exists, the code creates a placeholder master nodegroup on the fly, pre-accepted but without a UUID.</li>
<li>If the placeholder is the only nodegroup, the first cluster controller to register becomes the master.</li>
</ol>
<p>Sadly, there is some code complexity to clear up here as this logic is not encapsulated in a single place, but instead in both:</p>
<ul>
<li><code>NodeGroup.objects.ensure_data()</code> and</li>
<li><code>AnonNodeGroupsHandler.register()</code>.</li>
</ul>
{% endblock %}