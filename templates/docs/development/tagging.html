{% extends "docs/base_docs.html" %}

{% block page_class %}docs{% endblock %}

{% block content %}
<h1 id="tagging">Tagging</h1>
<h2 id="auto-tags-or-tags-with-expressions">Auto tags, or tags with expressions</h2>
<p>These kind of tags have an associated XPath expression that is evaluated against hardware information as obtained from running <code>lshw</code> during node commissioning.</p>
<h3 id="new-or-updated-tag-definition">New or updated tag definition</h3>
<p><strong>Note</strong> that this is somewhat outdated. See <a href="https://bugs.launchpad.net/maas/+bug/1372544">bug 1372544</a> (<em>Tag changes will never be evaluated on unconnected clusters</em>) for more information.</p>
<p>When a new tag is created or an existing tag is modified, its expression must be evaluated for every node known to the region. It's a moderately computationally intensive process, so the work is spread out to cluster controllers. Here's how:</p>
<ol>
<li><p>The region dispatches a <code>provisioningserver.tasks.update_node_tags</code> job to each cluster for each tag it wants evaluated.</p>
<p>It sends the tag name and its definition, an XPath expression.</p>
<p>See <code>maasserver.model.tags.Tag.save</code> and <code>maasserver.populate_tags</code>.</p></li>
<li>The task is run (by Celery) on each cluster. This calls <code>provisioningserver.tags.process_node_tags</code>.</li>
<li><p>The system IDs for all nodes in that cluster (aka node group) are fetched by calling back to the region.</p>
<p>See <code>provisioningserver.tags.get_nodes_for_node_group</code>.</p></li>
<li>Nodes are then processed in batches. For each batch:
<ol>
<li><p>Hardware details are obtained from the region for the batch as a whole.</p>
<p>See <code>provisioningserver.tags.get_hardware_details_for_nodes</code>.</p></li>
<li><p>The tag expression is evaluated against each node's hardware details. The result of the expression, cast as a boolean, determines if the tag applies to this node.</p>
<p>See <code>provisioningserver.tags.process_batch</code>.</p></li>
<li><p>The results are sent back to the region for the batch as a whole.</p>
<p>See <code>provisioningserver.tags.post_updated_nodes</code>.</p></li>
</ol></li>
</ol>
<h3 id="new-or-updated-commissioning-result">New or updated commissioning result</h3>
<p>When a new commissioning result comes in containing <code>lshw</code> or <code>lldp</code> XML output, every tag with an expression must be evaluated against the result so that the node is correctly tagged.</p>
<p>To do this, <code>VersionIndexHandler.signal</code> calls <code>populate_tags_for_single_node</code> just before saving all the changes. This happens in the <strong>region</strong>. While it's a computationally expensive operation, the overhead of spinning this work out to a cluster controller negates any benefit that might gained by doing so.</p>
<h2 id="manual-tags-or-tags-without-expressions">Manual tags, or tags without expressions</h2>
<p>The <em>manual</em> part refers to how these tags are associated with nodes. Instead of being automatically associated as the result of evaluating the tag expression, these tags must be manually associated with a node. A manual tag is denoted by the absence of an expression.</p>
{% endblock %}