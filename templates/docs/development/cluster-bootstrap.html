<h1 id="bootstrapping-a-cluster">Bootstrapping a cluster</h1>
<h2 id="considerations">Considerations</h2>
<p>A new cluster needs to register itself with the region. At the same moment that it's accepted by the region, the region starts configuring it via RPC, so we need an RPC connection open when registering.</p>
<p>Before a cluster is accepted, we want to restrict the available RPC calls to a small set, both on the region and the cluster.</p>
<p>Before a cluster is accepted, we also do not want to start some services on the cluster, like lease uploads, DHCP scanning, and so forth, because the region will reject interaction from them.</p>
<h2 id="start-up-procedure">Start-up procedure</h2>
<p>This procedure will be followed by existing clusters and new clusters alike:</p>
<ol>
<li>Cluster starts.</li>
<li>If shared secret not available, shutdown, <strong>DONE</strong>.</li>
<li><code>ClusterClientService</code> starts.</li>
<li>Services other than <code>log</code> are <strong>not</strong> started.</li>
<li>Wait for a connection to the region to become available.</li>
<li>Do not allow any RPC calls other than <code>Identify</code> and <code>Authenticate</code>.</li>
<li>Call <code>Identify</code>.</li>
<li>Call <code>Authenticate</code>.
<ul>
<li>On success, continue.</li>
<li>On failure, shutdown, <strong>DONE</strong>.</li>
</ul></li>
<li>Permit all other RPC calls.
<ul>
<li>This allows for side-effects from calling <code>Register</code> next, like DHCP configuration.</li>
</ul></li>
<li>Call <code>Register</code>. Region accepts cluster.</li>
<li>Start all services.</li>
<li><strong>DONE</strong>.</li>
</ol>
<h2 id="work-items">Work items</h2>
<ol>
<li><strong>DONE:</strong> Add <code>Authenticate</code> RPC call.</li>
<li><strong>DONE:</strong> Add <code>Register</code> RPC call.</li>
<li><strong>DONE:</strong> Command-line to install shared-secret.</li>
<li><strong>DONE:</strong> Check for shared-secret during start-up (packaging change too?).</li>
<li><strong>DONE:</strong> Perform <code>Authenticate</code> handshake.</li>
<li><strong>DONE:</strong> Perform <code>Register</code> handshake.</li>
<li><strong>DONE:</strong> Pass MAAS_URL in <code>Register</code> call. This replicates functionality found in <code>update_nodegroup_maas_url</code>, which is no longer used.</li>
<li>Display secret to admins in UI, or provide tool to obtain secret locally on region controller's machine.</li>
<li>Mechanism to limit available RPC calls.</li>
<li>Mechanism to defer start-up of &quot;full&quot; services.</li>
</ol>
