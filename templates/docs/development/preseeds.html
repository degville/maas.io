{% extends "docs/base_docs.html" %}

{% block page_class %}docs{% endblock %}

{% block content %}
<h1 id="how-preseeds-work-in-maas">How preseeds work in MAAS</h1>
<p>A preseed is what MAAS sends to the <code>cloud-init</code> process that starts up as part of node enlistment, commissioning and installation. It is a specially formatted chunk of text. MAAS does not care what that formatting is, it just knows it is text and uses <a href="http://pythonpaste.org/tempita/">Tempita</a> templates to render a final file based on variables that are required depending on the context.</p>
<h2 id="preseed-templates">Preseed templates</h2>
<p>On a live system, the preseed templates live in <code>/etc/maas/preseeds/</code>.</p>
<p>Each template uses a prefix that corresponds to a particular &quot;phase&quot;:</p>
<table>
<colgroup>
<col style="width: 22%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Phase</th>
<th style="text-align: left;">Prefix used</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Enlistment</td>
<td style="text-align: left;">enlist</td>
</tr>
<tr class="even">
<td style="text-align: left;">Commissioning</td>
<td style="text-align: left;">commissioning</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Installation</td>
<td style="text-align: left;">preseed_master (<a href="https://www.debian.org/devel/debian-installer/">DI</a>) or curtin (<a href="https://launchpad.net/curtin">Curtin</a>)</td>
</tr>
</tbody>
</table>
<p>Note that the preseed information is in fact composed of two files: the preseed file per se which usually contains little more than a URL and the credentials where to get the &quot;user data&quot; which, in turn, contains most of the logic to be executed.</p>
<h2 id="installation-preseed">Installation preseed</h2>
<p>The installation preseed is broken into the three files because the requirements are different depending on the installer being used. The <a href="https://www.debian.org/devel/debian-installer/">Debian Installer</a> uses <code>preseed_master</code> and the newer <a href="https://launchpad.net/curtin">Curtin</a> installer uses <code>curtin_userdata</code>.</p>
<p>The base of both of these is <code>generic</code>, which defines some variables and then selects the right one depending on the installer being used. Note that Tempita's inheritance mechanism is a little weird; the <code>generic</code> template inherits the right file but in effect this is in reverse, the inherited file becomes the new template and it can then reference the variables defined in <code>generic</code>.</p>
<h2 id="user-provided-preseeds">User-provided preseeds</h2>
<p>In addition to the standard preseed files, the base preseeds can be overridden on a per-OS, architecture, subarchitecture, OS release and node name basis. The templates are looked up in the following order:</p>
<pre><code>{prefix}_{osystem}_{node_arch}_{node_subarch}_{release}_{node_name}
{prefix}_{osystem}_{node_arch}_{node_subarch}_{release}
{prefix}_{osystem}_{node_arch}_{node_subarch}
{prefix}_{osystem}_{node_arch}
{prefix}_{osystem}
{prefix}
&#39;generic&#39;

Note: in order to be backward-compatible with earlier versions of MAAS that
only supported the Ubuntu OS, if the node OS is Ubuntu paths without the
{osystem} are also tried:
{prefix}_{osystem}_{node_arch}_{node_subarch}_{release}_{node_name}
{prefix}_{node_arch}_{node_subarch}_{release}_{node_name}
{prefix}_{osystem}_{node_arch}_{node_subarch}_{release}
{prefix}_{node_arch}_{node_subarch}_{release}
{prefix}_{osystem}_{node_arch}_{node_subarch}
{prefix}_{node_arch}_{node_subarch}
{prefix}_{osystem}_{node_arch}
{prefix}_{node_arch}
{prefix}_{osystem}
{prefix}
&#39;generic&#39;</code></pre>
<p><code>prefix</code> is either empty (in which case the following underscore is also ommitted: e.g. {osystem}_{node_arch}_{node_subarch}_{release}) or one of <code>enlist</code>, <code>enlist_userdata</code>, <code>commissioning</code>, <code>curtin</code>, <code>curtin_userdata</code> or <code>preseed_master</code>.</p>
<p>As you can see this mechanism is also used to calculate the base preseeds for all of installation, enlistment and commissioning. It allows end users to add, for example, a file named <code>curtin_ubuntu_amd64_generic</code> that would be used at installation time.</p>
<h2 id="curtin-configuration">Curtin configuration</h2>
<p><a href="https://launchpad.net/curtin">Curtin</a> is the tool responsible for performing the OS installation. If you need to customize the installation, you need to change Curtin's user data (by either changing the existing <code>curtin_userdata</code> file or adding a custom version as described above).</p>
<p>There isn't a complete documentation on how to customize Curtin at the time of this writing but the following instructions and examples should cover most of the use cases.</p>
<p>Curtin provides hooks to execute custom code before (early) or after (late) the installation takes place. You can override these hooks to execute code, either code that will run in the ephemeral environment or in the machine being installed itself (in-target). Note that you can execute in-target code only in a late command.</p>
<h3 id="example-early-command">Example: early command</h3>
<p>Here is an example of an early command (i.e. one that will run before the installation takes place) that runs in the ephemeral environment and pings an external machine to signal that the installation is about to start.</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">early_commands:</span>
  <span class="fu">signal:</span> <span class="kw">[</span><span class="fu">wget, &#39;--no-proxy&#39;, &#39;http:</span>//example.com/&#39;, &#39;--post-data&#39;, &#39;system_id={{node.system_id}}&amp;signal=starting_install&#39;, &#39;-O&#39;, &#39;/dev/null&#39;]</code></pre>
<h3 id="example-late-command">Example: late command</h3>
<p>Here is an example of two late commands (i.e. commands that will run after the installation has been performed). Both run in-target (i.e. in the machine being installed). The first command adds a PPA to the machine. The second command create a file containing the node's system_id. (Note that these are just examples of the things that can be done.)</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">late_commands:</span>
  <span class="fu">add_repo:</span> <span class="kw">[</span><span class="st">&quot;curtin&quot;</span><span class="fu">, &quot;in-target&quot;, &quot;--&quot;, &quot;add-apt-repository&quot;, &quot;-y&quot;, &quot;ppa:</span>my/ppa&quot;]
  <span class="fu">custom:</span> curtin in-target -- sh -c &quot;/bin/echo -en &#39;Installed {{node.system_id}}&#39; &gt; /tmp/maas_system_id&quot;</code></pre>
{% endblock %}