<h1 id="the-metadata-api">The Metadata API</h1>
<p>A MAAS region controller provides a separate API (the metadata API) for the benefit of the nodes themselves. This is where a node obtains the details of how it should be set up, such as which SSH keys should be installed in order to give a particular user remote access to the system.</p>
<p>As a MAAS user or administrator, you do not need to request this information yourself. It is normally up to <code>cloud-init</code> to do this while setting up the node. You'll find more about how this works in cloud-init's <a href="http://cloudinit.readthedocs.org/en/latest/topics/datasources.html">datasources</a> documentation.</p>
<h2 id="similarity-to-ec2">Similarity to EC2</h2>
<p>The metadata API is very similar, and partly identical, to the EC2 metadata service. It follows a similar directory structure and provides several items in the same formats. For example, in order to find out its own host name, a node would perform an http GET request for:</p>
<pre><code>/2012-03-01/meta-data/local-hostname</code></pre>
<p>The first item in the path is the API version. The API has been extended since March 2012, but not changed incompatibly and so that date is still the current version number.</p>
<p>The items following that form a directory hierarchy based on that of the EC2 metadata service. The metadata service &quot;knows&quot; which node makes the request, and so there is no need for the request URL to identify the node whose hostname should be retrieved. The request automatically returns the hostname for the node which requested it.</p>
<p>Just like EC2, the MAAS metadata API will accept GET requests to:</p>
<pre><code>/
/2012-03-01/
/2012-03-01/meta-data/
/2012-03-01/meta-data/instance-id
/2012-03-01/meta-data/local-hostname
/2012-03-01/meta-data/public-keys
/2012-03-01/user-data</code></pre>
<p>Hopefully their meanings are fairly obvious. The <code>public-keys</code> will contain the user's SSH keys.</p>
<p>MAAS adds a tarball of scripts that a node should run during its commissioning phase:</p>
<pre><code>/2012-03-01/meta-data/maas-commissioning-scripts</code></pre>
<p>There are other differences. Where EC2 makes the metadata service available at a fixed IP address, MAAS configures the location of the metadata service on the node while installing its operating system. It does this through installation preseeds &lt;preseeds&gt;. These preseeds also include the node's access credentials.</p>
<h2 id="additional-directory-trees">Additional Directory Trees</h2>
<p>MAAS adds some entirely new directories as well. An enlisting node (which does not have access credentials for the metadata API yet) can anonymously request the same items for itself under <code>/enlist/</code>, e.g.:</p>
<pre><code>/enlist/2012-03-01/meta-data/local-hostname</code></pre>
<p>If you set the <code>ALLOW_UNSAFE_METADATA_ACCESS</code> configuration item, the metadata service will also provide the information on arbitrary nodes to authenticated users under a separate sub-tree. For security reasons this is not recommended, but it may be useful in debugging. With this option enabled, the information for the node with MAC address 99:99:99:99:99:99 is available at:</p>
<pre><code>/2012-03-01/by-mac/99:99:99:99:99:99/meta-data/local-hostname</code></pre>
<p>And so on for the other information. There is a similar facility keyed by MAAS system identifiers.</p>
<p>Finally, a curtin-specific metadata API with largely the same information lives in the <code>/curtin/</code> subtree:</p>
<pre><code>/curtin/2012-03-01/meta-data/local-hostname</code></pre>
<p>The curtin subtree however differs in the <code>user-data</code> endpoint. It returns a curtin-specific form of user data.</p>
<h2 id="authentication">Authentication</h2>
<p>Most metadata requests are authenticated similar to ones to the region-controller API, through OAuth. Every node in a MAAS has its own OAuth key. (On the region controller side, these keys collectively belong to a single special user called <code>node-init</code>. You will not see such special users listed in the UI, however.) When a node asks for information about itself, the OAuth key is what tells the metadata service which node that is.</p>
<p>Not all requests are authenticated in this way. For instance, a node can access the items under the enlistment subdirectory (see above &lt;enlistment-tree&gt;) anonymously. The metadata service will identify the requesting node by its IP address.</p>
<h2 id="api-operations">API Operations</h2>
<p>The MAAS metadata API supports a few non-GET operations. These work just like the ones on the main region-controller API &lt;region-controller-api&gt;, but they are meant to be invoked by nodes. The URL for these calls is <code>/2013-03-01/</code>, and the operation name is passed as a multipart form item called &quot;op&quot;. Other parameters are passed in the same way.</p>
<p>The <code>signal</code> call notifies the region controller of the state of a commissioning node. The node sends running updates, as well as output produced by the commissioning scripts, and finally completion information through this call.</p>
<p>When a node is done installing, it may call POST operations <code>netboot_on</code> and <code>netboot_off</code> to instruct MAAS to enable or disable its network boot setting.</p>
